# 人工智慧醫學影像第一次作業

The report is generated by W & B platform, and is public open source 

Author : 311657007 統計碩一

Test set Accuracy: 90.4 % 

## Configuration

config = {
    'base_root': "C:/pythonScript/CXR/cxr/xray_jpg",
    'csv_name': "chest_dongdong.csv",
    'debug': False,
    'resume': "",
    'classes': 7,
    'img_size': 512,
    'normalize': True,
    'classes_name': ['主動脈硬化(鈣化)', '動脈彎曲', '肺野異常', '肺紋增加', '脊椎病變', '心臟肥大', '肺尖肋膜增厚'],
    'device': "cuda",
    'epochs': 20,
    'n_splits': 5,
    "batch_size": 4,
    'optimizer': "adamw",
    'model_name': "tf_efficientnet_b2_ns",
    'lr': 1e-4,
    'weight_decay': 1e-6,
    'amp': False,
    'lr_scheduler': "poly",
    'T_max': 10,
    'patience': 2,
    'factor': 0.5,
    'random_state': 42,
    'threshold': 0.5,
    'tta': False,
    'monitor': "f1",
    'loss_func': "FocalLoss",
    'alpha': 0.5,
    'beta': 0.5,
    'gamma': 2,
    'k': 3,
    'average': None,
    'project': "CXR-Binary-Classification",
    'entity': "DDCVLAB",
    'name': "Testing",
    "sweep": False,
    "count": 5,
    "rotate_degree": 5,
}


sweep_config = {
    "program": "main.py",
    "method": "grid",
    "metrics": {'goal': 'minimize', 'name': 'val_loss'},
    "parameters": {
        "lr": {
            "values": [1e-3, 5e-4, 1e-4, 5e-5]
        },
        "weight_decay": {
            "values": [1e-6, 1e-7, 1e-8]
        },
        "threshold": {
            "values": [0.4, 0.5, 0.6]
        }
    }
}

## Experimental

Before we deep dive into our disscussion, we first illustarte the difficulity of this work.

The data are slightly imbalance, therefore, we may encounter the overfitting problem, that is, most of the images are belong to class pneumonia, and will infect model predictions, so, we have tried something to reduce the influence of imbalance data.

Here are our experimentals

Main idea:

- Weighted Loss Function: In this approach, we adopt the WeightedBCE Loss
- Oversampling: To reduce the influence of data imbalance, we try to oversample the data
- Fine tune classifier: Since the data is simple to train (only two classes), we first train 5 epochs only for the classifier, then fine tune all the parameters exactly 1 epoch.
- EfficientNet: EfficientNet is the SOTA of CNN Image Classification. We use the pretrained model EfficientNetB4_NS from the timm (pytorch image model) library for training
- Simple augmentation: To be honestly, I don't seen any difference between normal subject and pneumonia subject, so, we are not using complex augmentation technique but simple rotation and horizontal flip.

Notice: Since the data are imbalance, more epochs is not a optimize solution to improve model performance, moreover, it may decrease our model performance due to overfit.

## Future Work

1. Loss for imbalance: Focal Loss、LMDA Loss, ... 
2. SMOTE
3. 5 Folds 
4. Ensemble
5. TTA (Test Time Augmentation)
6. Heavy augmentation







